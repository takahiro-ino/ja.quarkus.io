<!DOCTYPE html>
<html>





<head>
  <title>Using the Cassandra Client - 2.2 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/2.2/guides/cassandra" />
  <meta property="og:title" content="Using the Cassandra Client - 2.2" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/cassandra">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  

<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://ja.quarkus.io/">日本語 - JAPANESE</a></li>
          <li><a href="https://cn.quarkus.io/">简体中文 - CHINESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/2.2/guides/">ガイド一覧に戻る</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">ガイドのバージョンを選択</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.10 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" selected>2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" >1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">Using the Cassandra Client </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#前提条件">前提条件</a></li>
<li><a href="#アーキテクチャ">アーキテクチャ</a></li>
<li><a href="#ソリューション">ソリューション</a></li>
<li><a href="#空白の-maven-プロジェクトの作成">空白の Maven プロジェクトの作成</a></li>
<li><a href="#データモデルとデータアクセスオブジェクトの作成">データモデルとデータアクセスオブジェクトの作成</a></li>
<li><a href="#サービスと-jsonrest-エンドポイントの作成">サービスと JSONREST エンドポイントの作成</a></li>
<li><a href="#connecting-to-the-cassandra-database">Connecting to the Cassandra Database</a>
<ul class="sectlevel2">
<li><a href="#connecting-to-apache-cassandra-or-datastax-enterprise-dse">Connecting to Apache Cassandra or DataStax Enterprise (DSE)</a></li>
<li><a href="#connecting-to-a-datastax-astra-cloud-database">Connecting to a DataStax Astra Cloud Database</a></li>
<li><a href="#高度なドライバー設定">高度なドライバー設定</a></li>
</ul>
</li>
<li><a href="#ローカル-cassandra-データベースの実行">ローカル Cassandra データベースの実行</a></li>
<li><a href="#testing-the-rest-api">Testing the REST API</a></li>
<li><a href="#フロントエンドの作成">フロントエンドの作成</a></li>
<li><a href="#reactive">Reactive Programming with the Cassandra Client</a></li>
<li><a href="#リアクティブ-rest-api-のテスト">リアクティブ REST API のテスト</a></li>
<li><a href="#リアクティブなフロントエンドの作成">リアクティブなフロントエンドの作成</a></li>
<li><a href="#ヘルスチェック">ヘルスチェック</a></li>
<li><a href="#メトリクス">メトリクス</a>
<ul class="sectlevel2">
<li><a href="#enabling-metrics-with-micrometer">Enabling Metrics with Micrometer</a></li>
<li><a href="#enabling-metrics-with-microprofile-metrics">Enabling Metrics with MicroProfile Metrics</a></li>
<li><a href="#enabling-cassandra-metrics">Enabling Cassandra Metrics</a></li>
</ul>
</li>
<li><a href="#ネイティブモードでの実行">ネイティブモードでの実行</a></li>
<li><a href="#eager-先行-vs-lazy-遅延-初期化">Eager (先行) vs Lazy (遅延) 初期化</a></li>
<li><a href="#まとめ">まとめ</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Apache Cassandra®は、フリーでオープンソースの分散型ワイドカラムストアのNoSQLデータベース管理システムで、多くのコモディティサーバーにまたがる大量のデータを処理するように設計されており、単一障害点のない高可用性を提供します。</p>
</div>
<div class="paragraph">
<p>このガイドでは、RESTサービスでCassandraデータベースを使用する方法を見ていきます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このエクステンションはサードパーティによって開発されたもので、Quarkus Platformの一部です。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="前提条件"><a class="anchor" href="#前提条件"></a>前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this quickstart guide, you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an IDE;</p>
</li>
<li>
<p>JDK 11+ installed with <code>JAVA_HOME</code> configured appropriately;</p>
</li>
<li>
<p><a href="https://www.graalvm.org/">GraalVM</a> installed with the <code>GRAALVM_HOME</code> environment variable configured appropriately, if you want to <a href="https://quarkus.io/guides/building-native-image">use the native mode</a>;</p>
</li>
<li>
<p>Apache Maven 3.8.1+</p>
</li>
<li>
<p>稼働中の <a href="https://cassandra.apache.org">Apache Cassandra</a>、 <a href="https://www.datastax.fr/products/datastax-enterprise">DataStax Enterprise</a>（DSE）、または <a href="https://astra.datastax.com">DataStax Astra</a>データベース、あるいはきれいなDockerのインストール</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="アーキテクチャ"><a class="anchor" href="#アーキテクチャ"></a>アーキテクチャ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このクイックスタート・ガイドでは、 <a href="https://docs.datastax.com/en/developer/java-driver/latest">DataStax Javaドライバー</a>を使用してApache Cassandra、DataStax Enterprise（DSE）、またはDataStax Astraデータベースに接続できる <a href="https://github.com/datastax/cassandra-quarkus">Cassandra Quarkusエクステンション</a>を使用してRESTアプリケーションを構築する方法を説明します。</p>
</div>
<div class="paragraph">
<p>このガイドでは、<a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/mapper">DataStax Object Mapper</a> も使用します。これは、Java から CQL にマッピングする強力なフレームワークで、CQLクエリーを手動で記述する手間を省くことで、アプリケーションのデータアクセス階層コードを大幅に簡素化します。</p>
</div>
<div class="paragraph">
<p>このガイドで構築されたアプリケーションは非常にシンプルです: ユーザーはフォームを使用してリストに要素を追加することができ、アイテムリストが更新されます。ブラウザーとサーバー間の情報はすべてJSONフォーマットで、各要素はCassandraデータベースに保存されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ソリューション"><a class="anchor" href="#ソリューション"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の章で紹介する手順に沿って、ステップを踏んでアプリを作成することをお勧めします。ただし、完成した例にそのまま進んでも構いません。</p>
</div>
<div class="paragraph">
<p>The solution is located in the <a href="https://github.com/datastax/cassandra-quarkus/tree/master/quickstart">quickstart directory</a> of the Cassandra Quarkus extension GitHub repository.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="空白の-maven-プロジェクトの作成"><a class="anchor" href="#空白の-maven-プロジェクトの作成"></a>空白の Maven プロジェクトの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、新しいMavenプロジェクトを作成し、 <code>quickstart</code> ディレクトリーに存在する <code>pom.xml</code> ファイルをコピーします。</p>
</div>
<div class="paragraph">
<p><code>pom.xml</code> 、必要なQuarkusのエクステンションや依存関係をすべてインポートしています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="データモデルとデータアクセスオブジェクトの作成"><a class="anchor" href="#データモデルとデータアクセスオブジェクトの作成"></a>データモデルとデータアクセスオブジェクトの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この例では、果物のリストを管理するアプリケーションを作成します。</p>
</div>
<div class="paragraph">
<p>まず、以下のように <code>Fruit</code> クラスであらわされるデータもデールを作成してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
@PropertyStrategy(mutable = false)
public class Fruit {

    @PartitionKey
    private final String name;

    private final String description;

    public Fruit(String name, String description) {
      this.name = name;
      this.description = description;
    }
  // getters, hashCode, equals, toString methods omitted for brevity
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>前述のとおり、ここではDataStax Object Mapperを使用しています。つまり、CQLクエリーを手動で記述するのではなく、データ・モデルにいくつかのアノテーションを付け、裏側でマッパーが適切なCQLクエリーを生成するのです。</p>
</div>
<div class="paragraph">
<p>これが、 <code>Fruit</code> クラスが <code>@Entity</code> でアノテーションされている理由です。このアノテーションは、Cassandraテーブルにマッピングされる _エンティティ・クラス_としてマークされます。このクラスのインスタンスは、Cassandraデータベースに自動的に永続化され、そこから取得されます。ここでは、テーブル名はクラス名から推測されます： <code>fruit</code> 。</p>
</div>
<div class="paragraph">
<p>また、<code>name</code> フィールドは Cassandra パーティションキーを表すため、ObjectMapper ライブラリーの別のアノテーションである <code>@PartitionKey</code> のアノテーションを付けています。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
エンティティークラスには通常、今回のように <code>@PropertyStrategy(mutable = false)</code> のアノテーションが付けられている場合を除き、デフォルトの引数なしのコンストラクタが必要です。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次のステップでは、 <code>Fruit</code> エンティティーのインスタンスを管理する DAO (データアクセスオブジェクト) インターフェイスを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Dao
public interface FruitDao {
  @Update
  void update(Fruit fruit);

  @Select
  PagingIterable&lt;Fruit&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このインターフェイスは、REST サービスで使用される操作を公開します。繰り返しになりますが、アノテーション <code>@Dao</code> は DataStaxObjectMapper から取得され、このインターフェイスの実装も自動的に生成されます。</p>
</div>
<div class="paragraph">
<p><code>findAll</code> メソッドの特別なリターンタイプにも注意してください <a href="https://docs.datastax.com/en/drivers/java/latest/com/datastax/oss/driver/api/core/PagingIterable.html"><code>PagingIterable</code></a>: これはドライバーによって返される結果セットの基本タイプです。</p>
</div>
<div class="paragraph">
<p>最後に、マッパーインターフェイスを作成しましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mapper
public interface FruitMapper {
  @DaoFactory
  FruitDao fruitDao();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Mapper</code> アノテーションは、DataStaxObjectMapper によって認識されるさらに別のアノテーションです。マッパーは DAO のインスタンスを構築します。この場合に、アウトマッパーは唯一の DAO である <code>FruitDao</code> のインスタンスを構築しています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="サービスと-jsonrest-エンドポイントの作成"><a class="anchor" href="#サービスと-jsonrest-エンドポイントの作成"></a>サービスと JSONREST エンドポイントの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここで、アプリケーションのビジネス層となる <code>FruitService</code> を作成し、Cassandraデータベースから果物をセーブ/ロードします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class FruitService {

  @Inject FruitDao dao;

  public void save(Fruit fruit) {
    dao.update(fruit);
  }

  public List&lt;Fruit&gt; getAll() {
    return dao.findAll().all();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>サービスがどのように <code>FruitDao</code> インスタンスに注入されているかに注意してください。この DAO インスタンスは自動的に注入されます。</p>
</div>
<div class="paragraph">
<p>Cassandra Quarkus エクステンションを使用すると、次の Bean のいずれかを独自のコンポーネントに挿入できます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>プロジェクト内にある <code>@Mapper</code> アノテーション付きインターフェイスすべて。</p>
</li>
<li>
<p>プロジェクト内のすべての <code>@Dao</code> アノテーション付きインターフェイス。ただし、このインターフェイスは、プロジェクトのマッパーインターフェイスで宣言されており、対応する <code>@DaoFactory</code> アノテーション付きメソッドによって生成されている場合に限ります。</p>
</li>
<li>
<p><a href="https://javadoc.io/doc/com.datastax.oss.quarkus/cassandra-quarkus-client/latest/com/datastax/oss/quarkus/runtime/api/session/QuarkusCqlSession.html"><code>QuarkusCqlSession</code></a> bean: このアプリケーションスコープのシングルトン Bean は、Cassandra クライアントへの主要なエントリーポイントです。これは、Quarkus 用に特別に調整されたメソッドを備えた特殊な Cassandra ドライバーセッションインスタンスです。javadoc をしっかり確認してください。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>この例では、 <code>FruitMapper</code> と <code>FruitDao</code> の両方をどこにでも注入できますが、 <code>FruitService</code> に <code>FruitDao</code> を注入しています。</p>
</div>
<div class="paragraph">
<p>最後に必要なのは、GETとPOSTのメソッドを公開するREST APIです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/fruits")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class FruitResource {

  @Inject FruitService fruitService;

  @GET
  public List&lt;FruitDto&gt; getAll() {
    return fruitService.getAll().stream().map(this::convertToDto).collect(Collectors.toList());
  }

  @POST
  public void add(FruitDto fruit) {
    fruitService.save(convertFromDto(fruit));
  }

  private FruitDto convertToDto(Fruit fruit) {
    return new FruitDto(fruit.getName(), fruit.getDescription());
  }

  private Fruit convertFromDto(FruitDto fruitDto) {
    return new Fruit(fruitDto.getName(), fruitDto.getDescription());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>FruitResource</code> が <code>FruitService</code> インスタンスを自動的に注入していることに注目してください。</p>
</div>
<div class="paragraph">
<p>通常、REST API とデータアクセス層の間で同じエンティティーオブジェクトを使用することはお勧めしません。各 API を互いに独立して進化させるには、これらのレイヤーを実際に分離し、個別の API を使用する必要があります。このように、異なるオブジェクトを ( <code>FruitDto</code> ) を使用する理由です。DTO という用語は、「Data Transfer Object」の略です。この DTO オブジェクトは、HTTP メッセージで JSON に対する変換を自動的に行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FruitDto {

  private String name;
  private String description;

  public FruitDto() {}

  public FruitDto(String name, String description) {
    this.name = name;
    this.description = description;
  }
  // getters and setters omitted for brevity
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The translation to and from JSON is done automatically by the Quarkus RestEasy extension, which is included in this guide&#8217;s pom.xml file. If you want to add it manually to your application, add the below snippet to your application&#8217;s ppm.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-resteasy&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-resteasy-jsonb&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
JSONのシリアライゼーションレイヤーで使用されるDTOクラスは、デフォルトの引数なしのコンストラクタが必要です。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>DTO から JSON への変換は自動的に処理されますが、それでも <code>Fruit</code> から <code>FruitDto</code> に、またはその逆に変換する必要があります。これは手動で行う必要があるので、 <code>FruitResource</code> で 2 つの変換メソッド <code>convertToDto</code> と <code>convertFromDto</code> を宣言しています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
この例では、 <code>Fruit</code> と <code>FruitDto</code> は非常に似ているので、すべてに <code>Fruit</code> を使用しないのはなぜかと思うかもしれませんが、実際には、DTO とエンティティーの構造が大きく異なることは珍しくありません。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connecting-to-the-cassandra-database"><a class="anchor" href="#connecting-to-the-cassandra-database"></a>Connecting to the Cassandra Database</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="connecting-to-apache-cassandra-or-datastax-enterprise-dse"><a class="anchor" href="#connecting-to-apache-cassandra-or-datastax-enterprise-dse"></a>Connecting to Apache Cassandra or DataStax Enterprise (DSE)</h3>
<div class="paragraph">
<p>構成する主なプロパティーは次のとおりです。Cassandraデータベースにアクセスするための <code>contact-points</code> 、ドライバーによって必要とされる <code>local-datacenter</code> そしてオプションでバインド先のキースペースです。</p>
</div>
<div class="paragraph">
<p>設定のサンプルは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.contact-points={cassandra_ip}:9042
quarkus.cassandra.local-datacenter={dc_name}
quarkus.cassandra.keyspace={keyspace}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例では、localhost上で動作する単一のインスタンスを使用しており、データを含むキースペースは <code>k1</code> となっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.contact-points=127.0.0.1:9042
quarkus.cassandra.local-datacenter=datacenter1
quarkus.cassandra.keyspace=k1</code></pre>
</div>
</div>
<div class="paragraph">
<p>クラスタがプレーンテキスト認証を必要とする場合は、さらに2つの設定を行う必要があります。 <code>username</code> と <code>password</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.auth.username=john
quarkus.cassandra.auth.password=s3cr3t</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="connecting-to-a-datastax-astra-cloud-database"><a class="anchor" href="#connecting-to-a-datastax-astra-cloud-database"></a>Connecting to a DataStax Astra Cloud Database</h3>
<div class="paragraph">
<p><a href="https://astra.datastax.com">DataStax Astra</a> に接続する場合には、接続先とデータセンターを提供する代わりに、いわゆる <em>セキュア接続バンドル</em> を提供して、Astra のセキュア接続バンドルファイルへの有効なパスを指定する必要があります。セキュア接続バンドルは、AstraWeb コンソールからダウンロードできます。</p>
</div>
<div class="paragraph">
<p>Astra クラスターでは常に認証が必要なため、ユーザー名とパスワードも指定する必要があります。</p>
</div>
<div class="paragraph">
<p>DataStax Astraのサンプル構成は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.cloud.secure-connect-bundle=/path/to/secure-connect-bundle.zip
quarkus.cassandra.auth.username=john
quarkus.cassandra.auth.password=s3cr3t
quarkus.cassandra.keyspace=k1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="高度なドライバー設定"><a class="anchor" href="#高度なドライバー設定"></a>高度なドライバー設定</h3>
<div class="paragraph">
<p><code>application.conf</code> または <code>application.json</code> ファイルを使用して、他の Java ドライバーの設定を設定することができます。これらのファイルは、アプリケーションのクラスパスに配置する必要があります。すべての設定は、基礎となるドライバー設定メカニズムに自動的に渡されます。 <code>application.properties</code> で <code>quarkus.cassandra</code> のプレフィックスを付けて定義された設定は、 <code>application.conf</code> または <code>application.json</code> で定義された設定よりも優先されます。</p>
</div>
<div class="paragraph">
<p>設定の全リストを見るには、 <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/">ドライバーの設定リファレンス</a> を参照してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ローカル-cassandra-データベースの実行"><a class="anchor" href="#ローカル-cassandra-データベースの実行"></a>ローカル Cassandra データベースの実行</h2>
<div class="sectionbody">
<div class="paragraph">
<p>デフォルトでは、Cassandra クライアントは、ポート 9042(デフォルトの Cassandra ポート)でローカル Cassandra データベースにアクセスするように構成されています。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
設定 <code>quarkus.cassandra.local-datacenter</code> が、Cassandraクラスターのデータセンターと一致していることを確認してください。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ローカルのデータセンターの名前がわからない場合は、以下の CQL クエリを実行することでこの値を見つけることができます : <code>SELECT data_center FROM system.local</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Docker を使用して Cassandra データベースを実行する場合は、次のコマンドを使用してバックグラウンドでデータベースを起動できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker run --name local-cassandra-instance -p 9042:9042 -d cassandra</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、アプリケーションで使用するキースペースとテーブルを作成する必要があります。Dockerを使用している場合は、以下のコマンドを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker exec -it local-cassandra-instance cqlsh -e "CREATE KEYSPACE IF NOT EXISTS k1 WITH replication = {'class':'SimpleStrategy', 'replication_factor':1}"
docker exec -it local-cassandra-instance cqlsh -e "CREATE TABLE IF NOT EXISTS k1.fruit(name text PRIMARY KEY, description text)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>CQLSH ユーティリティーを使用して、データベースに対話式に問い合わせることもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker exec -it local-cassandra-instance cqlsh</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-the-rest-api"><a class="anchor" href="#testing-the-rest-api"></a>Testing the REST API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>プロジェクトのルートディレクトリー:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mvn clean package</code> を実行してから、 <code>java -jar./target/cassandra-quarkus-quickstart-*-runner.jar</code> を実行してアプリケーションを起動します。</p>
</li>
<li>
<p>または、<code>mvn clean quarkus:dev</code> でアプリケーションを開発モードで実行します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これで、curl コマンドを使用して、基盤となる REST API と対話できます。</p>
</div>
<div class="paragraph">
<p>fruit を作成するには以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"name":"apple","description":"red and tasty"}' \
  http://localhost:8080/fruits</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fruit を回収するには以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X GET http://localhost:8080/fruits</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="フロントエンドの作成"><a class="anchor" href="#フロントエンドの作成"></a>フロントエンドの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>それでは、 <code>FruitResource</code> と対話するためのシンプルなウェブページを追加してみましょう。</p>
</div>
<div class="paragraph">
<p>Quarkus は、 <code>META-INF/resources</code> ディレクトリーの下にある静的リソースを自動的に提供します。 <code>src/main/resources/META-INF/resources</code> ディレクトリーに、<a href="src/main/resources/META-INF/resources/fruits.html">このファイル</a> の内容を含めて <code>fruits.html</code> ファイルを追加します。</p>
</div>
<div class="paragraph">
<p>これで、REST サービスと対話できるようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>まだの場合は、 <code>mvn clean quarkus:dev</code> を使用してアプリケーションを起動します。</p>
</li>
<li>
<p>ブラウザーで <code><a href="http://localhost:8080/fruits.html" class="bare">http://localhost:8080/fruits.html</a></code> を指定します。</p>
</li>
<li>
<p>フォームを使って新しいフルーツをリストに追加します。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive"><a class="anchor" href="#reactive"></a>Reactive Programming with the Cassandra Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://javadoc.io/doc/com.datastax.oss.quarkus/cassandra-quarkus-client/latest/com/datastax/oss/quarkus/runtime/api/session/QuarkusCqlSession.html"><code>QuarkusCqlSession</code> インタフェース</a> を使用すると、Quarkus およびそのリアクティブフレームワークである Mutiny をシームレスに統合する一連のリアクティブメソッドにアクセスできます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Mutinyに慣れていない方は、 <a href="mutiny-primer.html">Mutiny - 直感的なリアクティブプログラミングライブラリ</a>をご覧ください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mutiny でリアクティブプログラミングを使用してアプリケーションを書き換えてみましょう。</p>
</div>
<div class="paragraph">
<p>まず、リアクティブな方法で機能する別の DAO インターフェイスを宣言しましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Dao
public interface ReactiveFruitDao {

  @Update
  Uni&lt;Void&gt; updateAsync(Fruit fruit);

  @Select
  MutinyMappedReactiveResultSet&lt;Fruit&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MutinyMappedReactiveResultSet</code> の使い方に注意してください。これは、ドライバが返すオリジナルの <code>Publisher</code> から変換された特殊な <code>Mutiny</code> 型で、クエリの実行情報を取得するなど、いくつかの追加メソッドも公開されています。このインターフェイスで何も必要としない場合は、単純に <code>Multi</code> を返すようにメソッドを宣言することもできます: <code>Multi&lt;Fruit&gt; findAll()</code> 、</p>
</div>
<div class="paragraph">
<p>同様に、メソッド <code>updateAsync</code> は <code>Uni</code> を返します。これは、ドライバーが返す元の結果セットから自動的に変換されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cassandraドライバは、リアクティブコールにReactive Streamsの <code>Publisher</code> APIを使用しています。しかし、QuarkusフレームワークではMutinyを使用しています。そのため、 <code>CqlQuarkusSession</code> インターフェイスは、ドライバが返す <code>Publisher</code> インスタンスを透過的にリアクティブ型の <code>Multi</code> に変換します。 <code>CqlQuarkusSession</code> は <code>Publisher</code> を <code>Uni</code> に変換することもできます - この場合、パブリッシャーは最大で1行を出力し、その後完了することが期待されます。これは書き込みクエリ(行を返さない)や、最大で1行を返すことが 保証されている読み込みクエリ(例えばカウントクエリ)に適しています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、 <code>FruitMapper</code> を適応させて、 <code>ReactiveFruitDao</code> インスタンスを構築する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mapper
public interface FruitMapper {
  // the existing method omitted

  @DaoFactory
  ReactiveFruitDao reactiveFruitDao();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、リアクティブ DAO を活用する <code>ReactiveFruitService</code> を作成できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class ReactiveFruitService {

  @Inject ReactiveFruitDao fruitDao;

  public Uni&lt;Void&gt; add(Fruit fruit) {
    return fruitDao.update(fruit);
  }

  public Multi&lt;Fruit&gt; getAll() {
    return fruitDao.findAll();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に、 <code>ReactiveFruitResource</code> を作成できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/reactive-fruits")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class ReactiveFruitResource {

  @Inject ReactiveFruitService service;

  @GET
  public Multi&lt;FruitDto&gt; getAll() {
    return service.getAll().map(this::convertToDto);
  }

  @POST
  public Uni&lt;Void&gt; add(FruitDto fruitDto) {
    return service.add(convertFromDto(fruitDto));
  }

  private FruitDto convertToDto(Fruit fruit) {
    return new FruitDto(fruit.getName(), fruit.getDescription());
  }

  private Fruit convertFromDto(FruitDto fruitDto) {
    return new Fruit(fruitDto.getName(), fruitDto.getDescription());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記のリソースは、新しいエンドポイント <code>reactive-fruits</code> を公開しています。その機能は、以前に <code>FruitResource</code> で作成したものと同じですが、すべてがブロッキング操作なしでリアクティブな方法で処理されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
上記の <code>getAll ()</code> メソッドは <code>Multi</code> を返し、 <code>add ()</code> メソッドは <code>Uni</code> を返します。これらのタイプは、以前使用した Mutiny タイプと同じで、Quarkus リアクティブ REST API により自動的に認識されるので、JSON に変換する必要はありません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To effectively integrate the reactive logic with the REST API, your application needs to declare a dependency to the Quarkus RestEasy Mutiny extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-resteasy-mutiny&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>この依存関係は、本書の pom.xml にすでに含まれていますが、新しいプロジェクトを最初から開始する場合は必ず追加するようにしてください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="リアクティブ-rest-api-のテスト"><a class="anchor" href="#リアクティブ-rest-api-のテスト"></a>リアクティブ REST API のテスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p>上で説明したようにアプリケーションを開発モードで実行すると、curl コマンドを使用して基盤となる REST API と対話できます。</p>
</div>
<div class="paragraph">
<p>リアクティブ REST エンドポイントを使用して fruit を作成するには以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"name":"banana","description":"yellow and sweet"}' \
  http://localhost:8080/reactive-fruits</code></pre>
</div>
</div>
<div class="paragraph">
<p>リアクティブ REST エンドポイントを使用して fruit を取得するには以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X GET http://localhost:8080/reactive-fruits</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="リアクティブなフロントエンドの作成"><a class="anchor" href="#リアクティブなフロントエンドの作成"></a>リアクティブなフロントエンドの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次に、 <code>ReactiveFruitResource</code> と対話するための簡単な Web ページを追加しましょう。 <code>src/main/resources/META-INF/resources</code> ディレクトリーに、 <a href="src/main/resources/META-INF/resources/reactive-fruits.html">このファイル</a> の内容を含めて <code>reactive-fruits.html</code> ファイルを追加します。</p>
</div>
<div class="paragraph">
<p>これで、リアクティブな REST サービスと対話できるようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>まだの場合は、 <code>mvn clean quarkus:dev</code> を使用してアプリケーションを起動します。</p>
</li>
<li>
<p>ブラウザーで <code><a href="http://localhost:8080/reactive-fruits.html" class="bare">http://localhost:8080/reactive-fruits.html</a></code> を指定します。</p>
</li>
<li>
<p>フォームを使って新しいフルーツをリストに追加します。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ヘルスチェック"><a class="anchor" href="#ヘルスチェック"></a>ヘルスチェック</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus SmallRye Health エクステンションを使用している場合には、Cassandra クライアントは、Cassandra クラスターへの接続を検証するための準備ヘルスチェックを自動的に追加します。このエクステンションは、本書の pom.xml にすでに含まれていますが、アプリケーションに手動で含める必要がある場合は、次を追加してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-smallrye-health&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>ヘルスチェックが利用可能になると、アプリケーションの <code>/health/ready</code> エンドポイントにアクセスして、接続検証ステータスに関する情報を取得できます。</p>
</div>
<div class="paragraph">
<p><code>mvn clean quarkus:dev</code> を使用して開発モードで実行している場合には、ブラウザーで <a href="http://localhost:8080/health/ready" class="bare">http://localhost:8080/health/ready</a> を指定すると、次のような出力が表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">{
    "status": "UP",
    "checks": [
        {
            "name": "DataStax Apache Cassandra Driver health check",
            "status": "UP",
            "data": {
                "cqlVersion": "3.4.4",
                "releaseVersion": "3.11.7",
                "clusterName": "Test Cluster",
                "datacenter": "datacenter1",
                "numberOfNodes": 1
            }
        }
    ]
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
アプリケーションでヘルスチェックをグローバルに有効にする必要があるが、Cassandra ヘルスチェックは有効にしない場合は、 <code>application.properties</code> で <code>quarkus.cassandra.health.enabled</code> プロパティーを <code>false</code> に設定して Cassandra ヘルスチェックを無効にできます。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="メトリクス"><a class="anchor" href="#メトリクス"></a>メトリクス</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra Quarkus クライアントは、Cassandra セッションおよび個々の Cassandra ノードに関するメトリクスを提供できます。このクライアントは、Micrometer と MicroProfile の両方をサポートします。</p>
</div>
<div class="paragraph">
<p>メトリクスの有効化の最初のステップは、使用する予定のメトリクスフレームワークに応じて、いくつかの依存関係を追加することです。</p>
</div>
<div class="sect2">
<h3 id="enabling-metrics-with-micrometer"><a class="anchor" href="#enabling-metrics-with-micrometer"></a>Enabling Metrics with Micrometer</h3>
<div class="paragraph">
<p>Micrometer is the recommended metrics framework in Quarkus applications since Quarkus 1.9.</p>
</div>
<div class="paragraph">
<p>アプリケーションで Micrometer メトリクスを有効にするには、pom.xml に以下を追加する必要があります。</p>
</div>
<div class="paragraph">
<p>For Quarkus 1.11+:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.datastax.oss&lt;/groupId&gt;
  &lt;artifactId&gt;java-driver-metrics-micrometer&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Quarkus &lt; 1.11:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.datastax.oss&lt;/groupId&gt;
  &lt;artifactId&gt;java-driver-metrics-micrometer&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-micrometer&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
  &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>このガイドでは Micrometer を使用しているため、上記の依存関係はこのガイドの pom.xml にすでに含まれています。</p>
</div>
</div>
<div class="sect2">
<h3 id="enabling-metrics-with-microprofile-metrics"><a class="anchor" href="#enabling-metrics-with-microprofile-metrics"></a>Enabling Metrics with MicroProfile Metrics</h3>
<div class="paragraph">
<p>pom.xml から Micrometer への依存関係を削除し、代わりに次の依存関係を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.datastax.oss&lt;/groupId&gt;
  &lt;artifactId&gt;java-driver-metrics-microprofile&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-smallrye-metrics&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-cassandra-metrics"><a class="anchor" href="#enabling-cassandra-metrics"></a>Enabling Cassandra Metrics</h3>
<div class="paragraph">
<p>アプリケーションでメトリクスが有効になっている場合でも、この機能をオプトインしない限り、Cassandra クライアントはメトリクスを報告しません。そのため、次のステップとして、 <code>application.properties</code> ファイルで Cassandra メトリクスを有効化してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.metrics.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>以上です!</p>
</div>
<div class="paragraph">
<p>最後の手順 (任意) で、Cassandra クライアントに追跡させる特定の Cassandra メトリクスをカスタマイズします。複数のメトリクスを追跡できますが、この手順をスキップすると、有用なメトリクスのデフォルトセットが自動的に追跡されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
使用可能なメトリクス名の完全なリストについては、 <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/">Driver Setting Reference</a> ページを参照してください。このページで <code>advanced.metrics</code> セクションを検索してください。また、Cassandra ドライバーのメトリクスについては、 <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/metrics/">ドライバーマニュアル</a> で詳しく説明されています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>追跡するメトリクスをカスタマイズする場合は、次のプロパティーを使用する必要があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>quarkus.cassandra.metrics.session.enabled</code> には、有効にするセッションレベルのメトリクス (セッションに対してグローバルなメトリクス) が含まれている必要があります。</p>
</li>
<li>
<p><code>quarkus.cassandra.metrics.node.enabled</code> には、有効にするノードレベルのメトリクス (Cassandra クライアントが接続する各ノードが独自のメトリクス値を取得するメトリクス) が含まれている必要があります 。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>どちらのプロパティーにも、有効なメトリクス名をコンマ区切りにした一覧を使用できます。</p>
</div>
<div class="paragraph">
<p>たとえば、次の 3 つの Cassandra メトリクスを有効にする場合には、以下のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>セッションレベル: <code>session.connected-nodes</code> および <code>session.bytes-sent</code>;</p>
</li>
<li>
<p>ノードレベル: <code>node.pool.open-connections</code>。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>次に、<code>application.properties</code> に以下の設定を追加する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.metrics.enabled=true
quarkus.cassandra.metrics.session.enabled=connected-nodes,bytes-sent
quarkus.cassandra.metrics.node.enabled=pool.open-connections</code></pre>
</div>
</div>
<div class="paragraph">
<p>本書の <code>application.properties</code> ファイルでは、すでに多くのメトリクスが有効になっています。このメトリクスリストを開始点として使用して、アプリケーションの有用な Cassandra メトリクスを公開すると適切です。</p>
</div>
<div class="paragraph">
<p>メトリクスが適切に有効になっている場合には、有効になっているすべてのメトリクスのメトリクスレポートは、アプリケーションの <code>/metrics</code> REST エンドポイントで利用できます。</p>
</div>
<div class="paragraph">
<p><code>mvn clean quarkus:dev</code> を使用して開発モードで実行している場合には、ブラウザーで <code><a href="http://localhost:8080/metrics" class="bare">http://localhost:8080/metrics</a></code> を指定するとメトリクスのリストが表示されます。名前に <code>cassandra</code> が含まれているメトリクスを検索します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Cassandra メトリクスを表示するには、Cassandra クライアントを初期化して接続する必要があります。遅延初期化 (以下を参照) を使用している場合には、アプリケーションが、実際に接続してデータベースに初めてアクセスするまで、Cassandra メトリクスは表示されません。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ネイティブモードでの実行"><a class="anchor" href="#ネイティブモードでの実行"></a>ネイティブモードでの実行</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GraalVM をインストールした場合は、以下を使用して、 <a href="https://quarkus.io/guides/building-native-image">ネイティブイメージのビルド</a> が可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn clean package -Dnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>ネイティブコンパイルにはかなりの時間がかかる可能性があることに注意してください。コンパイルが完了したら、次のようにネイティブ実行可能ファイルを実行できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">./target/cassandra-quarkus-quickstart-*-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>その後、ブラウザで <code><a href="http://localhost:8080/fruits.html" class="bare">http://localhost:8080/fruits.html</a></code> を開いてアプリケーションを使用します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eager-先行-vs-lazy-遅延-初期化"><a class="anchor" href="#eager-先行-vs-lazy-遅延-初期化"></a>Eager (先行) vs Lazy (遅延) 初期化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このエクステンションでは、どちらかを注入することができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>QuarkusCqlSession</code> Bean;</p>
</li>
<li>
<p>この Bean ( <code>CompletionStage&lt;QuarkusCqlSession&gt;</code> ) の非同期バージョン;</p>
</li>
<li>
<p>またはこの Bean のリアクティブバージョン (<code>Uni&lt;QuarkusCqlSession&gt;</code>)。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>最も簡単なアプローチは、明らかに <code>QuarkusCqlSession</code> を直接注入することです。これは、ほとんどのアプリケーションで問題なく機能するはずですが、<code>QuarkusCqlSession</code> Bean を使用する前に初期化する必要があるため、このプロセスはブロックされています。</p>
</div>
<div class="paragraph">
<p>幸いにも、初期化のタイミングを制御できます。 <code>quarkus.cassandra.init.eager-init</code> パラメーターは、 <code>QuarkusCqlSession</code> bean を最初にアクセスしたタイミング (lazy) または、アプリケーションが起動するタイミング (eager) のいずれで初期化するべきかを判断します。このパラメーターのデフォルト値は、 <code>false</code> で、init プロセスが遅延設定されていることを意味しています。たとえば、Cassandra データベースと対話する必要がある最初の REST 要求がある場合に、 <code>QuarkusCqlSession</code> bean は、遅延して、最初にアクセスしたタイミングで初期化されます。</p>
</div>
<div class="paragraph">
<p>遅延初期化を使用すると、アプリケーションの起動時間が短縮され、Cassandra データベースが利用できない場合に起動が失敗しないようになります。ただし、完全に非同期のコードを使用している場合には、リスクが発生する可能性があります。たとえば、 <a href="https://quarkus.io/guides/reactive-routes">reactive routes</a> を使用する場合には、Vert.x イベントループスレッドなど、ブロックされるべきでないスレッドで遅延初期化が誤って発生してしまう可能性があります。そのため、このようなコンテキストでは <code>quarkus.cassandra.init.eager-init</code> を <code>false</code> に設定して <code>QuarkusCqlSession</code> の挿入は避けるべきです。</p>
</div>
<div class="paragraph">
<p>Vert.x (またはその他のリアクティブフレームワーク) を使用して遅延初期化の動作を維持する場合は、代わりに <code>CompletionStage&lt;QuarkusCqlSession&gt;</code> または <code>Uni&lt;QuarkusCqlSession&gt;</code> だけを挿入してください。これらの Bean を注入すると、初期化プロセスは遅延してトリガーされますが、Vert.x イベントループを利用して、ブロックされない方法でバックグラウンドで実行されます。このようにして、Vert.x スレッドをブロックするリスクを回避できます。</p>
</div>
<div class="paragraph">
<p>または、<code>quarkus.cassandra.init.eager-init</code> を true に設定することもできます。この場合には、セッション Bean は、アプリケーションの起動時に、Quarkus メインスレッドで先行して初期化されます。これにより、Vert.x スレッドをブロックするリスクがなくなりますが、起動時間が (はるかに) 長くなります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="まとめ"><a class="anchor" href="#まとめ"></a>まとめ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クライアント・アプリケーションからのCassandraデータベースへのアクセスは、QuarkusとCassandraエクステンションで簡単に行えます。</p>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">日本語</a></li>
          
            <li><a href="https://cn.quarkus.io/">简体中文</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
