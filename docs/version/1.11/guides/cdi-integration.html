<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - CDI Integration Guide - 1.11</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/1.11/guides/cdi-integration" />
  <meta property="og:title" content="Quarkus - CDI Integration Guide - 1.11" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/cdi-integration">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  

<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://ja.quarkus.io/">日本語 - JAPANESE</a></li>
          <li><a href="https://cn.quarkus.io/">简体中文 - CHINESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/1.11/guides/">ガイド一覧に戻る</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">ガイドのバージョンを選択</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.10 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" selected>1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">Quarkus - CDI Integration Guide </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#メタデータソース">1. メタデータソース</a></li>
<li><a href="#ユースケース-クラスがbeanとして認識されません">2. ユースケース - クラスがBeanとして認識されません</a>
<ul class="sectlevel2">
<li><a href="#additional_bean_build_item">2.1. <em>理由1</em> :クラスが発見されない</a></li>
<li><a href="#理由2-クラスは発見されたがbeanを定義するアノテーションがない">2.2. <em>理由2</em> : クラスは発見されたが、Beanを定義するアノテーションがない</a></li>
<li><a href="#unremovable_builditem">2.3. <em>理由3</em>: クラスが検出され、Bean 定義のアノテーションがあるが削除されている</a></li>
</ul>
</li>
<li><a href="#ユースケース-アノテーションが修飾子またはインターセプターバインディングとして認識されない">3. ユースケース - アノテーションが修飾子またはインターセプターバインディングとして認識されない</a></li>
<li><a href="#annotations_transformer_build_item">4. ユースケース - メタデータを変換する必要があります</a></li>
<li><a href="#inspect_beans">5. 使用例 - Bean、オブザーバー、インジェクションポイントの検査</a>
<ul class="sectlevel2">
<li><a href="#解決策1-beandiscoveryfinishedbuilditem">5.1. <em>解決策1.</em> <code>BeanDiscoveryFinishedBuildItem</code></a></li>
<li><a href="#解決策2-synthesisfinishedbuilditem">5.2. <em>解決策2</em> : <code>SynthesisFinishedBuildItem</code></a></li>
</ul>
</li>
<li><a href="#synthetic_beans">6. ユースケース - 合成 Bean の必要性</a></li>
<li><a href="#synthetic_observers">7. ユースケース - 合成オブザーバー</a></li>
<li><a href="#generated_beans">8. ユースケース - 生成された Bean クラスがある</a></li>
<li><a href="#ユースケース-デプロイメントを検証する必要がある">9. ユースケース - デプロイメントを検証する必要がある</a></li>
<li><a href="#custom_context">10. ユースケース - カスタム CDI コンテキストの登録</a>
<ul class="sectlevel2">
<li><a href="#アプリケーションで使用されているすべてのスコープを知る必要がある場合はどうなりますか">10.1. アプリケーションで使用されているすべてのスコープを知る必要がある場合はどうなりますか?</a></li>
</ul>
</li>
<li><a href="#additional_interceptor_bindings">11. ユースケース - 追加のインターセプターバインディング</a></li>
<li><a href="#injection_point_transformation">12. ユースケース - インジェクションポイントの変換</a></li>
<li><a href="#ユースケース-リソースアノテーションとインジェクション">13. ユースケース - リソースアノテーションとインジェクション</a></li>
<li><a href="#build_metadata">14. 利用可能なビルドタイムメタデータ</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>CDI コンテナーである ArC はビルド時にブートストラップされます。このアプローチの欠点は、CDI Portable Extensionsをサポートできないことです。それにもかかわらず、Quarkus固有のエクステンションAPIを使用して機能を実現することができます。</p>
</div>
<div class="paragraph">
<p>コンテナーは複数のフェーズでブートストラップされます。高レベルの視点から見ると、これらのフェーズは以下のようになります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>初期化</p>
</li>
<li>
<p>Bean discovery</p>
</li>
<li>
<p>合成コンポーネントの登録</p>
</li>
<li>
<p>バリデーション</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>初期化</em> フェーズでは、準備作業が行われ、カスタムコンテキストが登録されます。その後、コンテナーがすべてのアプリケーションクラスを分析し、Beanを識別し、提供されたメタデータに基づいてそれらをすべて繋ぎ合わせるプロセスがBean <em>ディスカバリ</em> です。その後、エクステンションは <em>合成コンポーネント</em> を登録することができます。これらのコンポーネントの属性はエクステンションによって完全に制御されます。最後に、 <em>デプロイメントが検証されます</em> 。例えば、コンテナーはアプリケーション内のすべての注入ポイントを検証し、与えられた必要な型と修飾子を満たすBeanがない場合はビルドを失敗させます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
追加のロギングを有効にすることで、ブートストラップに関するより多くの情報を見ることができます。 <code>-X</code> または <code>--debug</code> で Maven ビルドを実行し、 <code>io.quarkus.arc</code> を含む行を grep するだけです。 <a href="cdi-reference.html#dev-mode">開発モード</a> では、 <code>quarkus.log.category."io.quarkus.arc.processor".level=DEBUG</code> を使用することができ、2つの特別なエンドポイントも自動的に登録され、JSON形式でいくつかの基本的なデバッグ情報を提供します。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Quarkusのビルドステップでは、さまざまなビルドアイテムを生成したり消費したりして、各フェーズにフックすることができます。以下のセクションでは、関連するすべてのビルド項目と一般的なシナリオについて説明します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="メタデータソース"><a class="anchor" href="#メタデータソース"></a>1. メタデータソース</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クラスとアノテーションは、Beanレベルのメタデータの主要なソースです。初期のメタデータは、Beanの <a href="cdi-reference.html#bean_discovery">ディスカバリ</a> 時に様々なソースから構築される不変の <a href="https://github.com/wildfly/jandex" target="<em>blank">Jandexインデックス</a> である _Beanアーカイブインデックス</em> から読み込まれます。しかし、エクステンションは、ブートストラップの特定の段階でメタデータを追加、削除、変換することができます。さらに、エクステンションは <a href="#synthetic_beans">合成コンポーネント</a> を登録することもできます。これは、CDIコンポーネントをQuarkusに統合する際に実現すべき重要な側面です。</p>
</div>
<div class="paragraph">
<p>このようにして、エクステンションは、そうでなければ無視されていたクラスをBeanに変えたり、その逆を行ったりすることができます。例えば、 <code>@Scheduled</code> メソッドを宣言するクラスは、たとえそれがBean定義アノテーションでアノテーションされておらず、通常は無視されるようなクラスであっても、常にBeanとして登録されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ユースケース-クラスがbeanとして認識されません"><a class="anchor" href="#ユースケース-クラスがbeanとして認識されません"></a>2. ユースケース - クラスがBeanとして認識されません</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>UnsatisfiedResolutionException</code> は、 <a href="cdi.html#typesafe_resolution">タイプセーフ解決</a> 時に問題があることを示しています。クラスパス上にインジェクションが可能なクラスがあっても、インジェクションポイントを満たすことができないことがあります。クラスが認識されない理由はいくつかありますが、それを解決する方法もいくつかあります。最初のステップでは、その <em>理由</em> を特定する必要があります。</p>
</div>
<div class="sect2">
<h3 id="additional_bean_build_item"><a class="anchor" href="#additional_bean_build_item"></a>2.1. <em>理由1</em> :クラスが発見されない</h3>
<div class="paragraph">
<p>Quarkusには <a href="cdi-reference.html#bean_discovery">簡易ディスカバリー</a> があります。クラスがアプリケーションのインデックスに含まれていないことが起こるかもしれません。例えば、Quarkusエクステンションの <em>ランタイムモジュール</em> のクラスは自動的にインデックス化されません。</p>
</div>
<div class="paragraph">
<p><em>解決策</em> 。 <code>AdditionalBeanBuildItem</code> .このビルド項目は、ディスカバリー中に解析する1つ以上の追加クラスを指定するために使用することができます。追加のBean・クラスは、コンテナーによって処理されるアプリケーション・インデックスに透過的に追加されます。</p>
</div>
<div class="listingblock">
<div class="title"><code>AdditionalBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
AdditionalBeanBuildItem additionalBeans() {
     return new AdditionalBeanBuildItem(SmallRyeHealthReporter.class, HealthServlet.class)); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>AdditionalBeanBuildItem.Builder</code> は、より複雑なユースケースに使用することができます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>AdditionalBeanBuildItem</code> 経由で追加された Bean クラスは、デフォルトでは <em>取り外し可能です</em> 。コンテナーがそれらを <a href="cdi-reference.html#remove_unused_beans">未使用</a> とみなした場合、それらはただ無視されます。しかし、 <code>AdditionalBeanBuildItem.Builder.setUnremovable()</code> メソッドを使用して、このビルド項目を介して登録されたBeanクラスを絶対に削除しないようにコンテナーに指示することができます。詳細は、未使用のBeanの <a href="cdi-reference.html#remove_unused_beans">削除</a> と <a href="#unremovable_builditem">[unremovable_builditem</a>] も参照してください。</p>
</div>
<div class="paragraph">
<p><code>AdditionalBeanBuildItem.Builder#setDefaultScope()</code> からデフォルトのスコープを設定することも可能です。デフォルトのスコープは、Beanクラスにスコープが宣言されていない場合にのみ使用されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
デフォルトスコープが指定されていない場合は <code>@Dependent</code> 擬似スコープが使用されます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="理由2-クラスは発見されたがbeanを定義するアノテーションがない"><a class="anchor" href="#理由2-クラスは発見されたがbeanを定義するアノテーションがない"></a>2.2. <em>理由2</em> : クラスは発見されたが、Beanを定義するアノテーションがない</h3>
<div class="paragraph">
<p>Quarkusでは、アプリケーションは <a href="https://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#default_bean_discovery" target="_blank" rel="noopener">ビーンディスカバリモード <code>annotated</code></a> でアノテーションされた単一のBeanアーカイブで表現されます。したがって、 <a href="https://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#bean_defining_annotations" target="_blank" rel="noopener">Bean 定義アノテーション</a> を持たないBeanクラスは無視されます。Bean定義アノテーションはクラスレベルで宣言され、スコープ、ステレオタイプ、 <code>@Interceptor</code> を含みます。</p>
</div>
<div class="paragraph">
<p><em>解決策1</em> : <code>AutoAddScopeBuildItem</code> の使用。このビルドアイテムを使用すると、特定の条件を満たすクラスにスコープを追加することができます。</p>
</div>
<div class="listingblock">
<div class="title"><code>AutoAddScopeBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
AutoAddScopeBuildItem autoAddScope() {
   return AutoAddScopeBuildItem.builder().containsAnnotations(SCHEDULED_NAME, SCHEDULES_NAME) <i class="conum" data-value="1"></i><b>(1)</b>
      .defaultScope(BuiltinScope.SINGLETON) <i class="conum" data-value="2"></i><b>(2)</b>
      .build();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Scheduled</code> でアノテーションされたすべてのクラスを検索</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>デフォルトのスコープとして <code>@Singleton</code> を追加。既にスコープでアノテーションされているクラスは自動的にスキップされます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>解決策2</em>: 特定のアノテーションが付けられたクラスを処理する必要がある場合は、<code>BeanDefiningAnnotationBuildItem</code> を介して Bean 定義アノテーションのセットを拡張することができます。</p>
</div>
<div class="listingblock">
<div class="title"><code>BeanDefiningAnnotationBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
BeanDefiningAnnotationBuildItem additionalBeanDefiningAnnotation() {
   return new BeanDefiningAnnotationBuildItem(Annotations.GRAPHQL_API); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bean 定義アノテーションのセットに <code>org.eclipse.microprofile.graphql.GraphQLApi</code> を追加します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>BeanDefiningAnnotationBuildItem</code> を介して追加された Bean クラスは、デフォルトでは <em>削除不可</em> です。したがって、結果の Bean は未使用と見なされても削除しないでください。ただし、デフォルトの動作は変更できます。詳細については<a href="cdi-reference#remove_unused_beans">Removing Unused Beans</a> および<a href="#unremovable_builditem">[unremovable_builditem]</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>デフォルトスコープを設定することもできます。デフォルトスコープは、Bean クラスにスコープが宣言されていない場合にのみ使用されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
デフォルトスコープが指定されていない場合は <code>@Dependent</code> 擬似スコープが使用されます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="unremovable_builditem"><a class="anchor" href="#unremovable_builditem"></a>2.3. <em>理由3</em>: クラスが検出され、Bean 定義のアノテーションがあるが削除されている</h3>
<div class="paragraph">
<p>デフォルトで、コンテナーはビルド時に <a href="cdi-reference#remove_unused_beans">remove all unused beans</a> を試行します。この最適化により、<em>フレームワークレベルでのデッドコードの排除</em> が可能になります。いくつかの特殊なケースでは、未使用の Bean を正しく特定できません。特に、Quarkus はまだ <code>CDI.current()</code> 静的メソッドの使用を検出できません。エクステンションは、<code>UnremovableBeanBuildItem</code> を生成することで、誤検出の可能性をなくすことができます。</p>
</div>
<div class="listingblock">
<div class="title"><code>UnremovableBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
UnremovableBeanBuildItem unremovableBeans() {
   return UnremovableBeanBuildItem.targetWithAnnotation(STARTUP_NAME); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Startup</code> でアノテーションされたすべてのクラスを削除できないようにする。</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ユースケース-アノテーションが修飾子またはインターセプターバインディングとして認識されない"><a class="anchor" href="#ユースケース-アノテーションが修飾子またはインターセプターバインディングとして認識されない"></a>3. ユースケース - アノテーションが修飾子またはインターセプターバインディングとして認識されない</h2>
<div class="sectionbody">
<div class="paragraph">
<p>アノテーションクラスがアプリケーションインデックスに含まれていない可能性があります。たとえば、Quarkus エクステンションの <em>ランタイムモジュール</em> のクラスは自動的にインデックス化されません。</p>
</div>
<div class="paragraph">
<p><em>解決策</em>: <a href="#additional_bean_build_item"><em>理由1</em> :クラスが発見されない</a> で説明されているとおりに <code>AdditionalBeanBuildItem</code> を使用します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="annotations_transformer_build_item"><a class="anchor" href="#annotations_transformer_build_item"></a>4. ユースケース - メタデータを変換する必要があります</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In some cases, it&#8217;s useful to be able to modify the metadata. Quarkus provides a powerful alternative to <a href="https://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#process_annotated_type" target="_blank" rel="noopener"><code>javax.enterprise.inject.spi.ProcessAnnotatedType</code></a>. With an <code>AnnotationsTransformerBuildItem</code> it&#8217;s possible to override the annotations that exist on bean classes.</p>
</div>
<div class="paragraph">
<p>たとえば、特定の Bean クラスにインターセプターバインディングを追加するとします。以下はその方法です。</p>
</div>
<div class="listingblock">
<div class="title"><code>AnnotationsTransformerBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
AnnotationsTransformerBuildItem transform() {
   return new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {

      public boolean appliesTo(org.jboss.jandex.AnnotationTarget.Kind kind) {
         return kind == org.jboss.jandex.AnnotationTarget.Kind.CLASS; <i class="conum" data-value="1"></i><b>(1)</b>
      }

      public void transform(TransformationContext context) {
         if (context.getTarget().asClass().name().toString().equals("org.acme.Bar")) {
            context.transform().add(MyInterceptorBinding.class).done(); <i class="conum" data-value="2"></i><b>(2)</b>
         }
      }
    });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>トランスフォーマーはクラスにのみ適用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>クラス名が <code>org.acme.Bar</code> と同じ場合は、<code>@MyInterceptorBinding</code> を追加します。<code>Transformation#done()</code> を呼び出すことを忘れないでください。</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
アノテーショントランスフォーマーは、Beanディスカバリが始まる <em>前に</em> 生成されなければならないことを覚えておいてください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ビルドステップでは、<code>TransformedAnnotationsBuildItem</code> を介して、特定のアノテーションターゲットの変換済みアノテーションをクエリーできます。</p>
</div>
<div class="listingblock">
<div class="title"><code>TransformedAnnotationsBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void queryAnnotations(TransformedAnnotationsBuildItem transformedAnnotations, BuildProducer&lt;MyBuildItem&gt; myBuildItem) {
   ClassInfo myClazz = ...;
   if (transformedAnnotations.getAnnotations(myClazz).isEmpty()) { <i class="conum" data-value="1"></i><b>(1)</b>
     myBuildItem.produce(new MyBuildItem());
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>TransformedAnnotationsBuildItem.getAnnotations()</code> は、変換された可能性のあるアノテーションのセットを返します。</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
変換に特化した他のビルドアイテム (<a href="#additional_interceptor_bindings">ユースケース - 追加のインターセプターバインディング</a> および<a href="#injection_point_transformation">ユースケース - インジェクションポイントの変換</a>) もあります。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inspect_beans"><a class="anchor" href="#inspect_beans"></a>5. 使用例 - Bean、オブザーバー、インジェクションポイントの検査</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="解決策1-beandiscoveryfinishedbuilditem"><a class="anchor" href="#解決策1-beandiscoveryfinishedbuilditem"></a>5.1. <em>解決策1.</em> <code>BeanDiscoveryFinishedBuildItem</code></h3>
<div class="paragraph">
<p><code>BeanDiscoveryFinishedBuildItem</code> のコンシューマーは、アプリケーションに登録されているすべてのクラスベースの Bean、オブザーバー、およびインジェクションポイントを簡単に検査できます。ただし、このビルドアイテムは合成コンポーネントが登録される <em>前</em> に作成されるため、合成 Bean とオブザーバーは <em>含まれません</em> 。</p>
</div>
<div class="paragraph">
<p>さらに、<code>BeanDiscoveryFinishedBuildItem#getBeanResolver()</code> から返された Bean リゾルバーを使用して、タイプセーフな解決ルールを適用できます。たとえば、必要なタイプと修飾子の特定の組み合わせを満たす Bean があるかどうかを確認できます。</p>
</div>
<div class="listingblock">
<div class="title"><code>BeanDiscoveryFinishedBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void doSomethingWithNamedBeans(BeanDiscoveryFinishedBuildItem beanDiscovery, BuildProducer&lt;NamedBeansBuildItem&gt; namedBeans) {
   List&lt;BeanInfo&gt; namedBeans = beanDiscovery.beanStream().withName().collect(toList())); <i class="conum" data-value="1"></i><b>(1)</b>
   namedBeans.produce(new NamedBeansBuildItem(namedBeans));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>結果のリストに <code>@Named</code> 合成 Bean は含まれません。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="解決策2-synthesisfinishedbuilditem"><a class="anchor" href="#解決策2-synthesisfinishedbuilditem"></a>5.2. <em>解決策2</em> : <code>SynthesisFinishedBuildItem</code></h3>
<div class="paragraph">
<p><code>SynthesisFinishedBuildItem</code> のコンシューマーは、アプリケーションに登録されているすべての Bean、オブザーバー、およびインジェクションポイントを簡単に検査できます。このビルドアイテムは合成コンポーネントが登録された <em>後</em> に作成されるため、合成 Bean とオブザーバーも <em>含まれます</em> 。</p>
</div>
<div class="paragraph">
<p>さらに、<code>SynthesisFinishedBuildItem#getBeanResolver()</code> から返された Bean リゾルバーを使用して、タイプセーフな解決ルールを適用できます。たとえば、必要なタイプと修飾子の特定の組み合わせを満たす Bean があるかどうかを確認できます。</p>
</div>
<div class="listingblock">
<div class="title"><code>SynthesisFinishedBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void doSomethingWithNamedBeans(SynthesisFinishedBuildItem synthesisFinished, BuildProducer&lt;NamedBeansBuildItem&gt; namedBeans) {
   List&lt;BeanInfo&gt; namedBeans = synthesisFinished.beanStream().withName().collect(toList())); <i class="conum" data-value="1"></i><b>(1)</b>
   namedBeans.produce(new NamedBeansBuildItem(namedBeans));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>結果のリストには、<code>@Named</code> 合成 Bean が含まれます。</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synthetic_beans"><a class="anchor" href="#synthetic_beans"></a>6. ユースケース - 合成 Bean の必要性</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes it is practical to be able to register a <em>synthetic bean</em>. Bean attributes of a synthetic bean are not derived from a Java class, method or field. Instead, all the attributes are defined by an extension. In regular CDI, this could be achieved using the <a href="https://docs.jboss.org/cdi/spec/2.0/cdi-spec.html#after_bean_discovery" target="_blank" rel="noopener"><code>AfterBeanDiscovery.addBean()</code></a> methods.</p>
</div>
<div class="paragraph">
<p><em>解決策</em>: 合成 Bean を登録する必要がある場合は、<code>SyntheticBeanBuildItem</code> を使用します。</p>
</div>
<div class="listingblock">
<div class="title"><code>SyntheticBeanBuildItem</code> Example 1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
SyntheticBeanBuildItem syntheticBean() {
   return SyntheticBeanBuildItem.configure(String.class)
             .qualifiers(new MyQualifierLiteral())
             .creator(mc -&gt; mc.returnValue(mc.load("foo"))) <i class="conum" data-value="1"></i><b>(1)</b>
             .done();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>javax.enterprise.context.spi.Contextual#create(CreationalContext&lt;T&gt;)</code> 実装の培土コードを生成します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Bean Configurator の出力は、バイトコードとして記録されます。したがって、実行時に合成 Bean インスタンスを作成する方法にはいくつかの制限があります。以下が可能です。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Contextual#create(CreationalContext&lt;T&gt;)</code> メソッドのバイトコードを、<code>ExtendedBeanConfigurator.creator(Consumer&lt;MethodCreator&gt;)</code> を介して直接生成します。</p>
</li>
<li>
<p><code>ExtendedBeanConfigurator#creator(Class&lt;? extends BeanCreator&lt;U&gt;&gt;)</code> を介して <code>io.quarkus.arc.BeanCreator</code> 実装クラスを渡し、可能であれば <code>ExtendedBeanConfigurator#param()</code> を介していくつかのパラメーターを指定します。</p>
</li>
<li>
<p><a href="writing-extensions#bytecode-recording"><code>@Recorder</code> メソッド</a> から返されたプロキシー経由でランタイムインスタンスを生成し、それを <code>ExtendedBeanConfigurator#runtimeValue(RuntimeValue&lt;?&gt;)</code> または <code>ExtendedBeanConfigurator#supplier(Supplier&lt;?&gt;)</code> 経由で設定します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>SyntheticBeanBuildItem</code> Example 2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(STATIC_INIT) <i class="conum" data-value="1"></i><b>(1)</b>
SyntheticBeanBuildItem syntheticBean(TestRecorder recorder) {
   return SyntheticBeanBuildItem.configure(Foo.class).scope(Singleton.class)
                .runtimeValue(recorder.createFoo()) <i class="conum" data-value="2"></i><b>(2)</b>
                .done();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>デフォルトでは、合成 Bean は <code>STATIC_INIT</code> の間に初期化されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bean インスタンスは、レコーダーメソッドから返される値によって提供されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>RUNTIME_INIT</code> の間に初期化される合成 Bean をマークできます。<code>STATIC_INIT</code> と <code>RUNTIME_INIT</code> の違いの詳細については、<a href="writing-extensions#bootstrap-three-phases">Three Phases of Bootstrap and Quarkus Philosophy</a> を参照してください。</p>
</div>
<div class="listingblock">
<div class="title"><code>RUNTIME_INIT</code> <code>SyntheticBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(RUNTIME_INIT) <i class="conum" data-value="1"></i><b>(1)</b>
SyntheticBeanBuildItem syntheticBean(TestRecorder recorder) {
   return SyntheticBeanBuildItem.configure(Foo.class).scope(Singleton.class)
                .setRuntimeInit() <i class="conum" data-value="2"></i><b>(2)</b>
                .runtimeValue(recorder.createFoo())
                .done();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>レコーダーは、<code>ExecutionTime.RUNTIME_INIT</code> フェーズで実行する必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bean インスタンスは、<code>RUNTIME_INIT</code> の間に初期化されます。</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>RUNTIME_INIT</code> の間に初期化された合成 Bean は、<code>STATIC_INIT</code> の間にアクセスしてはいけません。runtime-init 合成 Bean にアクセスする <code>RUNTIME_INIT</code> ビルドステップは、<code>SyntheticBeansRuntimeInitBuildItem</code> を消費します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(RUNTIME_INIT)
@Consume(SyntheticBeansRuntimeInitBuildItem.class) <i class="conum" data-value="1"></i><b>(1)</b>
void accessFoo(TestRecorder recorder) {
   recorder.foo(); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>このビルドステップは、<code>syntheticBean()</code> の完了後に実行する必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>このレコーダーメソッドでは <code>Foo</code> Bean インスタンスが呼び出されるため、必ずすべての合成 Bean が初期化された後にビルドステップが実行されることを確認する必要があります。</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>BeanRegistrationPhaseBuildItem</code> を使用して合成 Bean を登録することもできます。ただし、エクステンション作成者においては、Quarkus にとってより慣用的な <code>SyntheticBeanBuildItem</code> を使用することをお勧めします。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synthetic_observers"><a class="anchor" href="#synthetic_observers"></a>7. ユースケース - 合成オブザーバー</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#synthetic_beans">synthetic beans</a> と同様に、合成オブザーバーメソッドの属性は Java メソッドから派生しません。代わりに、すべての属性がエクステンションによって定義されます。</p>
</div>
<div class="paragraph">
<p><em>解決策</em>: 合成オブザーバーを登録する必要がある場合は、<code>ObserverRegistrationPhaseBuildItem</code> を使用します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>ObserverRegistrationPhaseBuildItem</code> を消費するビルドステップでは、常に <code>ObserverConfiguratorBuildItem</code> を生成するか、少なくともこのビルドアイテムに <code>BuildProducer</code> を 挿入する必要があります。でなければ、無視されるか、間違ったタイミングで処理される可能性があります (例: 正しい CDI ブートストラップフェーズの後)。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>ObserverRegistrationPhaseBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void syntheticObserver(ObserverRegistrationPhaseBuildItem observerRegistrationPhase,
            BuildProducer&lt;MyBuildItem&gt; myBuildItem,
            BuildProducer&lt;ObserverConfiguratorBuildItem&gt; observerConfigurators) {
   observerConfigurators.produce(new ObserverConfiguratorBuildItem(observerRegistrationPhase.getContext().configure().observedType(String.class)
                             .notify(mc -&gt; {
                               // do some gizmo bytecode generation...
                             }).done();
   myBuildItem.produce(new MyBuildItem());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ObserverConfigurator</code> の出力はバイトコードとして記録されます。したがって、実行時に合成オブザーバーを呼び出す方法にはいくつかの制限があります。現時点では、メソッド本体のバイトコードを直接生成する必要があります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generated_beans"><a class="anchor" href="#generated_beans"></a>8. ユースケース - 生成された Bean クラスがある</h2>
<div class="sectionbody">
<div class="paragraph">
<p>問題ありません。Bean クラスのバイトコードを手動で生成し、その後に <code>GeneratedClassBuildItem</code> ではなく <code>GeneratedBeanBuildItem</code> を生成してください。</p>
</div>
<div class="listingblock">
<div class="title"><code>GeneratedBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void generatedBean(BuildProducer&lt;GeneratedBeanBuildItem&gt; generatedBeans) {
    ClassOutput beansClassOutput = new GeneratedBeanGizmoAdaptor(generatedBeans); <i class="conum" data-value="1"></i><b>(1)</b>
    ClassCreator beanClassCreator = ClassCreator.builder().classOutput(beansClassOutput)
                .className("org.acme.MyBean")
                .build();
    beanClassCreator.addAnnotation(Singleton.class);
    beanClassCreator.close(); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>io.quarkus.arc.deployment.GeneratedBeanGizmoAdaptor</code> を使用すると、Gizmo コンストラクトから <code>GeneratedBeanBuildItem</code> を簡単に作成できます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>結果の Bean クラスは、次のようになります: <code>public class @Singleton MyBean { }</code>。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ユースケース-デプロイメントを検証する必要がある"><a class="anchor" href="#ユースケース-デプロイメントを検証する必要がある"></a>9. ユースケース - デプロイメントを検証する必要がある</h2>
<div class="sectionbody">
<div class="paragraph">
<p>エクステンションは、Bean、オブザーバー、およびインジェクションポイントを検査し、さらに追加の検証を実行して、何か問題がある場合はビルドを失敗にする必要があります。</p>
</div>
<div class="paragraph">
<p><em>解決策</em>: エクステンションがデプロイメントを検証する必要がある場合、<code>ValidationPhaseBuildItem</code> を使用します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>ValidationPhaseBuildItem</code> を消費するビルドステップでは、常に <code>ValidationErrorBuildItem</code> を生成するか、少なくともこのビルドアイテムに <code>BuildProducer</code> を 挿入する必要があります。でなければ、無視されるか、間違ったタイミングで処理される可能性があります (例: 正しい CDI ブートストラップフェーズの後)。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void validate(ValidationPhaseBuildItem validationPhase,
            BuildProducer&lt;MyBuildItem&gt; myBuildItem,
            BuildProducer&lt;ValidationErrorBuildItem&gt; errors) {
   if (someCondition) {
     errors.produce(new ValidationErrorBuildItem(new IllegalStateException()));
     myBuildItem.produce(new MyBuildItem());
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>ValidationPhaseBuildItem.getContext().beans()</code> メソッドから返される便利な <code>BeanStream</code> を使用して、登録されているすべての Bean を簡単にフィルタリングできます。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom_context"><a class="anchor" href="#custom_context"></a>10. ユースケース - カスタム CDI コンテキストの登録</h2>
<div class="sectionbody">
<div class="paragraph">
<p>時々、エクステンションは組み込みCDI コンテキストのセットを拡張する必要があります。</p>
</div>
<div class="paragraph">
<p><em>解決策</em>: カスタムコンテキストを登録する必要がある場合は、<code>ContextRegistrationPhaseBuildItem</code> を使用します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>ContextRegistrationPhaseBuildItem</code> を消費するビルドステップでは、常に <code>ContextConfiguratorBuildItem</code> を生成するか、少なくともこのビルドアイテムに `BuildProducer`を 挿入する必要があります。でなければ、無視されるか、間違ったタイミングで処理される可能性があります (例: 正しい CDI ブートストラップフェーズの後)。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ContextRegistrationPhaseBuildItem</code> Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
ContextConfiguratorBuildItem registerContext(ContextRegistrationPhaseBuildItem phase) {
      return new ContextConfiguratorBuildItem(phase.getContext().configure(TransactionScoped.class).normal().contextClass(TransactionContext.class));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>さらに、<code>ContextRegistrationPhaseBuildItem</code> を介してカスタム CDI コンテキストを登録する各エクステンションは、Bean 定義アノテーションのセットにカスタムスコープアノテーション名を提供するために、<code>CustomScopeBuildItem</code> も生成する必要があります。</p>
</div>
<div class="paragraph">
<p><code>CustomScopeBuildItem</code> Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
CustomScopeBuildItem customScope() {
   return new CustomScopeBuildItem(DotName.createSimple(TransactionScoped.class.getName()));
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="アプリケーションで使用されているすべてのスコープを知る必要がある場合はどうなりますか"><a class="anchor" href="#アプリケーションで使用されているすべてのスコープを知る必要がある場合はどうなりますか"></a>10.1. アプリケーションで使用されているすべてのスコープを知る必要がある場合はどうなりますか?</h3>
<div class="paragraph">
<p><em>ソリューション</em>: ビルドステップで <code>CustomScopeAnnotationsBuildItem</code> を挿入し、 <code>CustomScopeAnnotationsBuildItem.isScopeDeclaredOn()</code> などの便利なメソッドを使用できます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional_interceptor_bindings"><a class="anchor" href="#additional_interceptor_bindings"></a>11. ユースケース - 追加のインターセプターバインディング</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In rare cases it might be handy to programmatically register an existing annotation that is not annotated with <code>@javax.interceptor.InterceptorBinding</code> as an interceptor binding. This is similar to what CDI achieves through <code>BeforeBeanDiscovery#addInterceptorBinding()</code>. Though here we are going to use <code>InterceptorBindingRegistrarBuildItem</code> to get it done.</p>
</div>
<div class="listingblock">
<div class="title"><code>InterceptorBindingRegistrarBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
InterceptorBindingRegistrarBuildItem addInterceptorBindings() {
    return new InterceptorBindingRegistrarBuildItem(new InterceptorBindingRegistrar() {
        @Override
        public Map&lt;DotName, Set&lt;String&gt;&gt; registerAdditionalBindings() { <i class="conum" data-value="1"></i><b>(1)</b>
            return Collections.singletonMap(DotName.createSimple(NotAnInterceptorBinding.class.getName()),
                                        Collections.emptySet());
        }
    });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="injection_point_transformation"><a class="anchor" href="#injection_point_transformation"></a>12. ユースケース - インジェクションポイントの変換</h2>
<div class="sectionbody">
<div class="paragraph">
<p>プログラムでインジェクションポイントの修飾子を変更できると便利な場合があります。それは、<code>InjectionPointTransformerBuildItem</code> で実行できます。次のサンプルは、修飾子 <code>MyQualifier</code> を含むタイプ <code>Foo</code> のインジェクションポイント変換を適用する方法を示しています。</p>
</div>
<div class="listingblock">
<div class="title"><code>InjectionPointTransformerBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
InjectionPointTransformerBuildItem transformer() {
    return new InjectionPointTransformerBuildItem(new InjectionPointsTransformer() {

        public boolean appliesTo(Type requiredType) {
            return requiredType.name().equals(DotName.createSimple(Foo.class.getName()));
        }

        public void transform(TransformationContext context) {
            if (context.getQualifiers().stream()
                    .anyMatch(a -&gt; a.name().equals(DotName.createSimple(MyQualifier.class.getName())))) {
                context.transform()
                        .removeAll()
                        .add(DotName.createSimple(MyOtherQualifier.class.getName()))
                        .done();
            }
        }
    });
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
理論的には、<a href="#annotations_transformer_build_item"><code>AnnotationsTransformer</code></a> を使用して同じ目標を達成できます。ただし、次の多少の違いがあるため、このタスクには <code>InjectionPointsTransformer</code> の方が適しています。その違いとは次のとおりです。(1) アノテーショントランスフォーマーは Bean 検出中にすべてのクラスに適用されますが、<code>InjectionPointsTransformer</code> は Bean 検出後に検出されたインジェクションポイントにのみ適用されます。(2) <code>InjectionPointsTransformer</code> を使用すると、さまざまなタイプのインジェクションポイント (フィールド、初期化メソッドのパラメーターなど) を処理する必要がありません。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ユースケース-リソースアノテーションとインジェクション"><a class="anchor" href="#ユースケース-リソースアノテーションとインジェクション"></a>13. ユースケース - リソースアノテーションとインジェクション</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ResourceAnnotationBuildItem</code> を使用して、Jakarta EE リソースなどの非 CDI インジェクションポイントを解決できるリソースアノテーションを指定できます。インテグレーターは、対応する <code>io.quarkus.arc.ResourceReferenceProvider</code> サービスプロバイダー実装も提供する必要があります。</p>
</div>
<div class="listingblock">
<div class="title"><code>ResourceAnnotationBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void setupResourceInjection(BuildProducer&lt;ResourceAnnotationBuildItem&gt; resourceAnnotations, BuildProducer&lt;GeneratedResourceBuildItem&gt; resources) {
    resources.produce(new GeneratedResourceBuildItem("META-INF/services/io.quarkus.arc.ResourceReferenceProvider",
        MyResourceReferenceProvider.class.getName().getBytes()));
    resourceAnnotations.produce(new ResourceAnnotationBuildItem(DotName.createSimple(MyAnnotation.class.getName())));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build_metadata"><a class="anchor" href="#build_metadata"></a>14. 利用可能なビルドタイムメタデータ</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>BuildExtension.BuildContext</code> で動作する上記のエクステンションはいずれも、ビルドタイムに生成される特定のビルドタイムメタデータを利用することができます。 <code>io.quarkus.arc.processor.BuildExtension.Key</code> にある組込キーは以下の通りです。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ANNOTATION_STORE</dt>
<dd>
<p>アノテーショントランスフォーマーを適用した後は、すべての`AnnotationTarget`アノテーションに関する情報を保持する <code>AnnotationStore</code> が含まれます</p>
</dd>
<dt class="hdlist1">INJECTION_POINTS</dt>
<dd>
<p>すべてのインジェクションポイントを含む <code>Collection&lt;InjectionPointInfo&gt;</code></p>
</dd>
<dt class="hdlist1">BEANS</dt>
<dd>
<p>すべての Bean を含む <code>Collection&lt;BeanInfo&gt;</code></p>
</dd>
<dt class="hdlist1">REMOVED_BEANS</dt>
<dd>
<p><code>Collection&lt;BeanInfo&gt;</code> 削除されたすべての <a href="cdi-reference.html#remove_unused_beans">Bean</a> を含む</p>
</dd>
<dt class="hdlist1">OBSERVERS</dt>
<dd>
<p>すべてのオブザーバーを含む <code>Collection&lt;ObserverInfo&gt;</code></p>
</dd>
<dt class="hdlist1">SCOPES</dt>
<dd>
<p>カスタムスコープも含め、すべてのスコープを含む <code>Collection&lt;ScopeInfo&gt;</code></p>
</dd>
<dt class="hdlist1">QUALIFIERS</dt>
<dd>
<p><code>Map&lt;DotName, ClassInfo&gt;</code> すべての修飾子を含む</p>
</dd>
<dt class="hdlist1">INTERCEPTOR_BINDINGS</dt>
<dd>
<p>すべてのインターセプターバインディングを含む <code>Map&lt;DotName, ClassInfo&gt;</code></p>
</dd>
<dt class="hdlist1">STEREOTYPES</dt>
<dd>
<p>すべてのステレオタイプを含む <code>Map&lt;DotName, StereotypeInfo&gt;</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>これらのメタデータを取得するには、そのキーのエクステンションコンテキストオブジェクトをクエリするだけ可能です。これらのメタデータはビルドが進むにつれて利用可能になることに注意してください。エクステンションがまだ生成されていないメタデータを取得しようとすると、 <code>null</code> が返されます。どのエクステンションがどのメタデータにアクセスできるかをまとめてみました。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">AnnotationsTransformer</dt>
<dd>
<p>ブートストラップのどのフェーズでもいつでも使えるので、メタデータに頼るべきではありません。</p>
</dd>
<dt class="hdlist1">ContextRegistrar</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> . <code>STEREOTYPES</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">InjectionPointsTransformer</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> . <code>STEREOTYPES</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">ObserverTransformer</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> . <code>STEREOTYPES</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">BeanRegistrar</dt>
<dd>
<p><code>ANNOTATION_STORE</code>, <code>QUALIFIERS</code>, <code>INTERCEPTOR_BINDINGS</code>, <code>STEREOTYPES</code>, <code>BEANS</code> (class-based beans only), <code>OBSERVERS</code> (class-based observers only), <code>INJECTION_POINTS</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">ObserverRegistrar</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> , <code>STEREOTYPES</code> , <code>BEANS</code> , <code>OBSERVERS</code> (クラスベースのオブザーバーのみ), <code>INJECTION_POINTS</code> にアクセス可能です。</p>
</dd>
<dt class="hdlist1">BeanDeploymentValidator</dt>
<dd>
<p>すべてのビルドメタデータにアクセスできます</p>
</dd>
</dl>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">日本語</a></li>
          
            <li><a href="https://cn.quarkus.io/">简体中文</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
